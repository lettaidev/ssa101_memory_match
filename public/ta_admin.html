<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Memory Match</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .bg-grid {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(203,213,225,0.4) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(203,213,225,0.4) 1px, transparent 1px);
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }
        .glass-card { backdrop-filter: blur(12px); }
    </style>
</head>
<body class="min-h-screen antialiased font-sans bg-slate-50 text-slate-900">
    <div class="fixed inset-0 z-0 bg-grid pointer-events-none"></div>

    <!-- Nav -->
    <nav class="sticky top-0 z-50 w-full border-b border-slate-200 bg-white/80 backdrop-blur-md">
        <div class="max-w-5xl mx-auto px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="h-6 w-6 rounded-md bg-gradient-to-tr from-emerald-500 to-sky-500 flex items-center justify-center text-[0.6rem] font-semibold shadow-lg shadow-emerald-500/20">
                    <span class="text-white">MM</span>
                </div>
                <span class="text-sm font-semibold tracking-tight text-slate-900">Admin Panel</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/" class="text-xs font-medium text-slate-500 hover:text-emerald-600">Player</a>
                <a href="/scoreboard.html" class="text-xs font-medium text-slate-500 hover:text-emerald-600">Scoreboard</a>
            </div>
        </div>
    </nav>

    <main class="relative z-10 flex flex-col items-center w-full py-10 px-4">

        <!-- LOGIN GATE -->
        <div id="login-screen" class="w-full max-w-sm">
            <div class="text-center mb-8 space-y-2">
                <div class="inline-flex items-center gap-1.5 rounded-full border border-emerald-500/20 bg-emerald-500/10 px-2.5 py-0.5 text-[0.65rem] text-emerald-600 font-medium">
                    <span class="h-1.5 w-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span>Admin Access</span>
                </div>
                <h1 class="text-2xl font-semibold tracking-tight text-slate-900">Enter Admin Key</h1>
            </div>
            <div class="glass-card rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                <div class="p-6 space-y-4">
                    <input id="admin-key-input" type="password" placeholder="Admin key..."
                           class="w-full h-11 px-4 rounded-lg border border-slate-200 bg-white text-sm font-medium text-slate-900 placeholder-slate-400 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                    <button onclick="adminLogin()" class="w-full h-11 rounded-lg bg-emerald-500 text-white font-semibold text-sm shadow-lg shadow-emerald-500/25 hover:bg-emerald-400 transition-all">
                        Unlock
                    </button>
                    <p id="login-error" class="text-center text-xs text-red-500 hidden">Invalid key</p>
                </div>
            </div>
        </div>

        <!-- ADMIN PANEL (hidden until authed) -->
        <div id="admin-panel" class="w-full max-w-2xl space-y-6 hidden">

            <div class="text-center mb-8 space-y-2">
                <div class="inline-flex items-center gap-1.5 rounded-full border border-emerald-500/20 bg-emerald-500/10 px-2.5 py-0.5 text-[0.65rem] text-emerald-600 font-medium">
                    <span class="h-1.5 w-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span>Admin Control</span>
                </div>
                <h1 class="text-2xl font-semibold tracking-tight text-slate-900">Game Settings</h1>
            </div>

            <!-- Game Config -->
            <div class="glass-card rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                <div class="p-5 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-700">Configuration</h2>
                </div>
                <div class="p-5 space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs font-medium text-slate-500 mb-1 block">Time (minutes)</label>
                            <input id="cfg-time" type="number" min="1" max="60" value="2"
                                   class="w-full h-10 px-3 rounded-lg border border-slate-200 text-sm font-medium focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-500 mb-1 block">Match Points</label>
                            <input id="cfg-match" type="number" min="1" max="100" value="10"
                                   class="w-full h-10 px-3 rounded-lg border border-slate-200 text-sm font-medium focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-500 mb-1 block">Miss Penalty</label>
                            <input id="cfg-penalty" type="number" min="0" max="50" value="2"
                                   class="w-full h-10 px-3 rounded-lg border border-slate-200 text-sm font-medium focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                        </div>
                    </div>
                    <button onclick="saveConfig()" class="h-9 px-4 rounded-lg bg-slate-800 text-white text-xs font-semibold hover:bg-slate-700 transition-colors">
                        Save Config
                    </button>
                </div>
            </div>

            <!-- Game Actions -->
            <div class="glass-card rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                <div class="p-5 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-700">Game Control</h2>
                </div>
                <div class="p-5 flex gap-3">
                    <button onclick="startGame()" class="flex-1 h-11 rounded-lg bg-emerald-500 text-white font-semibold text-sm shadow-lg shadow-emerald-500/25 hover:bg-emerald-400 transition-all">
                        Start Game
                    </button>
                    <button onclick="resetGame()" class="flex-1 h-11 rounded-lg bg-red-500 text-white font-semibold text-sm shadow-lg shadow-red-500/25 hover:bg-red-400 transition-all">
                        Reset All
                    </button>
                </div>
                <div id="action-msg" class="px-5 pb-4 text-xs text-emerald-600 font-medium hidden"></div>
            </div>

            <!-- Bulk Import -->
            <div class="glass-card rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <div>
                        <h2 class="text-sm font-semibold text-slate-700">Bulk Import Words</h2>
                        <p class="text-[0.7rem] text-slate-400 mt-0.5">Paste multiple pairs at once — one pair per line</p>
                    </div>
                </div>
                <div class="p-5 space-y-3">
                    <!-- Format selector -->
                    <div class="flex items-center gap-4">
                        <label class="text-xs font-medium text-slate-500">Separator:</label>
                        <div class="flex gap-2">
                            <button onclick="setBulkSep('|')" id="sep-pipe" class="h-7 px-3 rounded-md text-xs font-semibold transition-colors bg-emerald-500 text-white">
                                Pipe ( | )
                            </button>
                            <button onclick="setBulkSep('tab')" id="sep-tab" class="h-7 px-3 rounded-md text-xs font-semibold transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Tab
                            </button>
                            <button onclick="setBulkSep(',')" id="sep-comma" class="h-7 px-3 rounded-md text-xs font-semibold transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Comma ( , )
                            </button>
                        </div>
                    </div>

                    <!-- Textarea -->
                    <div>
                        <textarea id="bulk-input" rows="8" placeholder="Apple | Quả táo&#10;Dog | Con chó&#10;Cat | Con mèo&#10;House | Ngôi nhà&#10;Book | Quyển sách"
                                  class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white text-sm font-mono text-slate-800 placeholder-slate-300 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 resize-y leading-relaxed"></textarea>
                    </div>

                    <!-- Preview + Actions -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <button onclick="previewBulk()" class="h-9 px-4 rounded-lg bg-slate-100 text-slate-700 text-xs font-semibold hover:bg-slate-200 transition-colors">
                                Preview
                            </button>
                            <span id="bulk-count" class="text-xs text-slate-400"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="bulkReplace()" class="h-9 px-4 rounded-lg bg-red-50 text-red-600 text-xs font-semibold hover:bg-red-100 transition-colors border border-red-200">
                                Replace All
                            </button>
                            <button onclick="bulkAppend()" class="h-9 px-4 rounded-lg bg-emerald-500 text-white text-xs font-semibold hover:bg-emerald-400 transition-colors shadow-sm shadow-emerald-500/20">
                                Append to Deck
                            </button>
                        </div>
                    </div>

                    <!-- Preview table -->
                    <div id="bulk-preview" class="hidden">
                        <div class="h-px w-full bg-slate-100 my-2"></div>
                        <div class="text-xs font-semibold uppercase tracking-wider text-slate-400 mb-2">Preview</div>
                        <div class="max-h-48 overflow-y-auto rounded-lg border border-slate-100">
                            <table class="w-full text-sm">
                                <thead class="sticky top-0 bg-slate-50">
                                    <tr class="text-[0.65rem] font-medium text-slate-400 uppercase tracking-wider">
                                        <th class="py-1.5 px-3 text-left">#</th>
                                        <th class="py-1.5 px-3 text-left">English</th>
                                        <th class="py-1.5 px-3 text-left">Vietnamese</th>
                                        <th class="py-1.5 px-3 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="bulk-preview-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Error messages -->
                    <div id="bulk-errors" class="hidden text-xs text-red-500 bg-red-50 rounded-lg p-3 border border-red-100"></div>
                </div>
            </div>

            <!-- Deck Editor -->
            <div class="glass-card rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <div>
                        <h2 class="text-sm font-semibold text-slate-700">Word Deck (A = English, B = Vietnamese)</h2>
                        <p class="text-[0.7rem] text-slate-400 mt-0.5"><span id="deck-count">0</span> pairs total</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearDeck()" class="h-7 px-3 rounded-md bg-red-50 text-red-500 text-xs font-semibold hover:bg-red-100 border border-red-200">Clear All</button>
                        <button onclick="addRow()" class="h-7 px-3 rounded-md bg-emerald-500/10 text-emerald-600 text-xs font-semibold hover:bg-emerald-500/20">+ Add Pair</button>
                    </div>
                </div>
                <div class="p-5">
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-white">
                                <tr class="text-xs font-medium text-slate-400 uppercase tracking-wider">
                                    <th class="pb-2 text-left">Pair</th>
                                    <th class="pb-2 text-left">Face A (EN)</th>
                                    <th class="pb-2 text-left">Face B (VN)</th>
                                    <th class="pb-2 text-center">On</th>
                                    <th class="pb-2"></th>
                                </tr>
                            </thead>
                            <tbody id="deck-tbody"></tbody>
                        </table>
                    </div>
                    <button onclick="saveDeck()" class="mt-4 h-9 px-4 rounded-lg bg-slate-800 text-white text-xs font-semibold hover:bg-slate-700 transition-colors">
                        Save Deck
                    </button>
                </div>
            </div>

            <!-- Teams list -->
            <div class="glass-card rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                <div class="p-5 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-700">Joined Teams</h2>
                </div>
                <div id="teams-list" class="p-5 text-sm text-slate-600">Loading...</div>
            </div>
        </div><!-- /admin-panel -->
    </main>

    <script>
        let deckData = [];
        let adminKey = sessionStorage.getItem('adminKey') || '';

        // Helper: gửi fetch kèm auth header
        function adminFetch(url, opts = {}) {
            const headers = opts.headers instanceof Headers ? Object.fromEntries(opts.headers) : (opts.headers || {});
            opts.headers = { ...headers, 'X-Admin-Key': adminKey };
            return fetch(url, opts);
        }

        // ─── Login ──────────────────────────────────────────────
        async function adminLogin() {
            const input = document.getElementById('admin-key-input');
            const key = input.value.trim();
            if (!key) return;

            const resp = await fetch('/api/admin', { headers: { 'X-Admin-Key': key } });
            if (resp.status === 401) {
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }

            adminKey = key;
            sessionStorage.setItem('adminKey', adminKey);
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAdmin();
        }

        document.getElementById('admin-key-input')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') adminLogin();
        });

        // Auto-login nếu đã có key trong session
        (async function tryAutoLogin() {
            if (!adminKey) return;
            const resp = await fetch('/api/admin', { headers: { 'X-Admin-Key': adminKey } });
            if (resp.ok) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAdmin();
            } else {
                sessionStorage.removeItem('adminKey');
                adminKey = '';
            }
        })();

        async function loadAdmin() {
            const resp = await adminFetch('/api/admin');
            const data = await resp.json();

            document.getElementById('cfg-time').value = Math.round(data.config.timeLimitSec / 60);
            document.getElementById('cfg-match').value = data.config.matchPoints;
            document.getElementById('cfg-penalty').value = data.config.missPenalty;

            deckData = data.deck;
            renderDeck();

            const teamsEl = document.getElementById('teams-list');
            if (data.teams.length === 0) {
                teamsEl.textContent = 'No teams joined yet.';
            } else {
                teamsEl.innerHTML = data.teams.map(t =>
                    `<div class="flex justify-between py-1 border-b border-slate-100 last:border-0">
                        <span class="font-medium text-slate-800">${escapeHtml(t.name)}</span>
                        <span class="text-slate-500">Score: ${t.score}</span>
                    </div>`
                ).join('');
            }
        }

        function renderDeck() {
            const tbody = document.getElementById('deck-tbody');
            tbody.innerHTML = deckData.map((d, i) => `
                <tr class="border-b border-slate-50">
                    <td class="py-2 pr-2 text-slate-400 font-medium">${d.pairId}</td>
                    <td class="py-2 pr-2"><input data-idx="${i}" data-field="faceA" value="${escapeHtml(d.faceA)}" class="w-full px-2 py-1 rounded border border-slate-200 text-sm focus:outline-none focus:border-emerald-500"></td>
                    <td class="py-2 pr-2"><input data-idx="${i}" data-field="faceB" value="${escapeHtml(d.faceB)}" class="w-full px-2 py-1 rounded border border-slate-200 text-sm focus:outline-none focus:border-emerald-500"></td>
                    <td class="py-2 text-center"><input type="checkbox" data-idx="${i}" data-field="enabled" ${d.enabled ? 'checked' : ''} class="accent-emerald-500"></td>
                    <td class="py-2 text-right"><button onclick="removeRow(${i})" class="text-red-400 hover:text-red-600 text-xs">Remove</button></td>
                </tr>
            `).join('');
            updateDeckCount();
        }

        function addRow() {
            const maxPairId = deckData.length > 0 ? Math.max(...deckData.map(d => d.pairId)) : 0;
            deckData.push({ pairId: maxPairId + 1, faceA: '', faceB: '', enabled: 1 });
            renderDeck();
        }

        function removeRow(idx) {
            deckData.splice(idx, 1);
            renderDeck();
        }

        function collectDeckFromUI() {
            document.querySelectorAll('#deck-tbody input[data-field="faceA"]').forEach(el => {
                deckData[parseInt(el.dataset.idx)].faceA = el.value;
            });
            document.querySelectorAll('#deck-tbody input[data-field="faceB"]').forEach(el => {
                deckData[parseInt(el.dataset.idx)].faceB = el.value;
            });
            document.querySelectorAll('#deck-tbody input[data-field="enabled"]').forEach(el => {
                deckData[parseInt(el.dataset.idx)].enabled = el.checked ? 1 : 0;
            });
        }

        async function saveConfig() {
            const timeMins = parseInt(document.getElementById('cfg-time').value) || 2;
            await adminFetch('/api/admin/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    timeLimitSec: timeMins * 60,
                    matchPoints: parseInt(document.getElementById('cfg-match').value) || 10,
                    missPenalty: parseInt(document.getElementById('cfg-penalty').value) || 0,
                }),
            });
            showMsg('Config saved!');
        }

        async function saveDeck() {
            collectDeckFromUI();
            await adminFetch('/api/admin/deck', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pairs: deckData }),
            });
            showMsg('Deck saved!');
        }

        async function startGame() {
            await saveConfig();
            collectDeckFromUI();
            await saveDeck();
            await adminFetch('/api/admin/start', { method: 'POST' });
            showMsg('Game started!');
            loadAdmin();
        }

        async function resetGame() {
            if (!confirm('Reset everything? All teams and scores will be deleted.')) return;
            await adminFetch('/api/admin/reset', { method: 'POST' });
            showMsg('Game reset!');
            loadAdmin();
        }

        function showMsg(text) {
            const el = document.getElementById('action-msg');
            el.textContent = text;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ─── Bulk Import ────────────────────────────────────────
        let bulkSep = '|';

        function setBulkSep(sep) {
            bulkSep = sep;
            // Update button styles
            ['sep-pipe', 'sep-tab', 'sep-comma'].forEach(id => {
                const btn = document.getElementById(id);
                btn.className = 'h-7 px-3 rounded-md text-xs font-semibold transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200';
            });
            const activeId = sep === '|' ? 'sep-pipe' : sep === 'tab' ? 'sep-tab' : 'sep-comma';
            document.getElementById(activeId).className = 'h-7 px-3 rounded-md text-xs font-semibold transition-colors bg-emerald-500 text-white';

            // Update placeholder
            const ta = document.getElementById('bulk-input');
            if (sep === '|') ta.placeholder = 'Apple | Quả táo\nDog | Con chó\nCat | Con mèo';
            else if (sep === 'tab') ta.placeholder = 'Apple\tQuả táo\nDog\tCon chó\nCat\tCon mèo';
            else ta.placeholder = 'Apple, Quả táo\nDog, Con chó\nCat, Con mèo';
        }

        function parseBulkInput() {
            const raw = document.getElementById('bulk-input').value.trim();
            if (!raw) return { pairs: [], errors: [] };

            const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const pairs = [];
            const errors = [];

            const separator = bulkSep === 'tab' ? '\t' : bulkSep;

            lines.forEach((line, idx) => {
                const parts = line.split(separator).map(s => s.trim()).filter(s => s.length > 0);
                if (parts.length < 2) {
                    errors.push(`Line ${idx + 1}: "${line}" — missing separator or second value`);
                    return;
                }
                if (parts.length > 2) {
                    errors.push(`Line ${idx + 1}: "${line}" — too many separators (using first two parts)`);
                }
                pairs.push({ faceA: parts[0], faceB: parts[1] });
            });

            return { pairs, errors };
        }

        function previewBulk() {
            const { pairs, errors } = parseBulkInput();
            const errEl = document.getElementById('bulk-errors');
            const previewEl = document.getElementById('bulk-preview');
            const countEl = document.getElementById('bulk-count');

            // Show errors
            if (errors.length > 0) {
                errEl.innerHTML = errors.map(e => escapeHtml(e)).join('<br>');
                errEl.classList.remove('hidden');
            } else {
                errEl.classList.add('hidden');
            }

            // Show preview
            if (pairs.length > 0) {
                countEl.textContent = `${pairs.length} pairs found`;
                const body = document.getElementById('bulk-preview-body');
                body.innerHTML = pairs.map((p, i) => `
                    <tr class="border-b border-slate-50 ${i % 2 === 0 ? '' : 'bg-slate-50/50'}">
                        <td class="py-1.5 px-3 text-slate-400 font-medium">${i + 1}</td>
                        <td class="py-1.5 px-3 font-medium text-slate-800">${escapeHtml(p.faceA)}</td>
                        <td class="py-1.5 px-3 text-slate-600">${escapeHtml(p.faceB)}</td>
                        <td class="py-1.5 px-3 text-center"><span class="inline-block h-1.5 w-1.5 rounded-full bg-emerald-500"></span></td>
                    </tr>
                `).join('');
                previewEl.classList.remove('hidden');
            } else {
                countEl.textContent = '';
                previewEl.classList.add('hidden');
            }
        }

        function bulkAppend() {
            const { pairs, errors } = parseBulkInput();
            if (pairs.length === 0) {
                previewBulk();
                return;
            }

            collectDeckFromUI();
            const maxPairId = deckData.length > 0 ? Math.max(...deckData.map(d => d.pairId)) : 0;

            pairs.forEach((p, i) => {
                deckData.push({ pairId: maxPairId + i + 1, faceA: p.faceA, faceB: p.faceB, enabled: 1 });
            });

            renderDeck();
            document.getElementById('bulk-input').value = '';
            document.getElementById('bulk-preview').classList.add('hidden');
            document.getElementById('bulk-errors').classList.add('hidden');
            document.getElementById('bulk-count').textContent = '';
            showMsg(`Appended ${pairs.length} pairs to deck. Don't forget to Save Deck!`);
        }

        function bulkReplace() {
            const { pairs, errors } = parseBulkInput();
            if (pairs.length === 0) {
                previewBulk();
                return;
            }
            if (!confirm(`Replace entire deck with ${pairs.length} new pairs?`)) return;

            deckData = pairs.map((p, i) => ({
                pairId: i + 1, faceA: p.faceA, faceB: p.faceB, enabled: 1
            }));

            renderDeck();
            document.getElementById('bulk-input').value = '';
            document.getElementById('bulk-preview').classList.add('hidden');
            document.getElementById('bulk-errors').classList.add('hidden');
            document.getElementById('bulk-count').textContent = '';
            showMsg(`Replaced deck with ${pairs.length} pairs. Don't forget to Save Deck!`);
        }

        function clearDeck() {
            if (!confirm('Clear all pairs from deck?')) return;
            deckData = [];
            renderDeck();
            showMsg('Deck cleared. Don\'t forget to Save Deck!');
        }

        function updateDeckCount() {
            const el = document.getElementById('deck-count');
            if (el) el.textContent = deckData.length;
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
        });
    </script>
</body>
</html>
